{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}My Profile | Drishti{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Profile Header -->
    <div class="card border-0 shadow-sm mb-4 overflow-hidden">
        {% if not is_complete %}
        <div class="card-body p-5 text-center">
            <div class="mb-4">
                <div class="rounded-circle bg-primary bg-opacity-10 d-inline-flex align-items-center justify-content-center"
                    style="width: 80px; height: 80px;">
                    <i data-lucide="user-check" class="w-10 h-10 text-primary"></i>
                </div>
            </div>
            <h3 class="fw-bold mb-3">Complete Your Profile</h3>
            <p class="text-muted mb-4">Please provide your Aadhaar Number and Occupation to unlock full features and
                earn <span class="fw-bold text-success">50 Karma Points</span>!</p>

            <form method="post" enctype="multipart/form-data" class="text-start mx-auto" style="max-width: 500px;">
                {% csrf_token %}

                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase text-muted">Aadhaar Number</label>
                    {{ form.aadhaar_number }}
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase text-muted">Occupation</label>
                    {{ form.occupation }}
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase text-muted">Bio</label>
                    {{ form.bio }}
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase text-muted">Profile Picture</label>
                    {{ form.profile_picture }}
                </div>

                <!-- Hidden fields for existing data if needed, or just let them be updated if in form -->
                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase text-muted">Phone Number</label>
                    {{ form.phone_number }}
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase text-muted">Address</label>
                    {{ form.address }}
                </div>

                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary btn-lg rounded-pill">
                        Save & Earn 50 Points
                    </button>
                </div>
            </form>
        </div>
        {% else %}
        <div class="card-body p-0">
            <div class="bg-primary p-4 text-white text-center"
                style="background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);">
                <div class="mb-3 position-relative d-inline-block">
                    <div class="rounded-circle bg-white text-primary d-flex align-items-center justify-content-center mx-auto fs-1 fw-bold shadow-lg border border-4 border-white"
                        style="width: 120px; height: 120px;">
                        {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" alt="Profile"
                            class="rounded-circle w-100 h-100 object-fit-cover">
                        {% else %}
                        {{ user.username|slice:":1"|upper }}
                        {% endif %}
                    </div>
                    <span
                        class="position-absolute bottom-0 end-0 p-2 bg-success border border-4 border-white rounded-circle"
                        title="Verified Citizen">
                        <span class="visually-hidden">Verified</span>
                    </span>
                </div>
                <h3 class="fw-bold mb-1">{{ user.get_full_name|default:user.username }}</h3>
                <p class="opacity-75 mb-1">Citizen ID: #{{ user.id|stringformat:"06d" }}</p>
                <p class="opacity-75 mb-3 badge bg-white bg-opacity-25">{{ user.occupation|default:"Citizen" }}</p>

                <div class="d-flex justify-content-center gap-3">
                    <span class="badge bg-white bg-opacity-25 rounded-pill px-3 py-2">
                        <i data-lucide="map-pin" class="w-4 h-4 me-1"></i> {{
                        user.state|default:user.address|default:"Location Not Set" }}
                    </span>
                    <span class="badge bg-white bg-opacity-25 rounded-pill px-3 py-2">
                        <i data-lucide="shield" class="w-4 h-4 me-1"></i> Civic Guardian (Level 1)
                    </span>
                </div>
            </div>

            <div class="row g-0 text-center py-3 bg-light border-top">
                <div class="col-4 border-end">
                    <h5 class="fw-bold mb-0 text-primary">{{ user.points|default:"0" }}</h5>
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Karma Points</small>
                </div>
                <div class="col-4 border-end">
                    <h5 class="fw-bold mb-0 text-success">{{ user.complaint_set.count }}</h5>
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Grievances Filed</small>
                </div>
                <div class="col-4">
                    <h5 class="fw-bold mb-0 text-warning">0</h5>
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Rewards Claimed</small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="row g-4">
        <!-- Personal Details -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="fw-bold mb-0">Personal Information</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="small text-muted fw-bold d-block text-uppercase">Full Name</label>
                        <div class="fw-medium">{{ user.get_full_name|default:"--" }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted fw-bold d-block text-uppercase">Email Address</label>
                        <div class="fw-medium">{{ user.email }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted fw-bold d-block text-uppercase">Phone Number</label>
                        <div class="fw-medium">{{ user.phone_number|default:"--" }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted fw-bold d-block text-uppercase">Residential Address</label>
                        <div class="fw-medium">{{ user.address|default:"--" }}</div>
                    </div>
                    <div class="d-grid mt-4">
                        <button class="btn btn-outline-primary rounded-pill">Edit Profile</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rewards Section -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-primary">
                        <i data-lucide="gift" class="w-5 h-5 me-2"></i>Rewards & Benefits
                    </h6>
                    <span class="badge bg-primary bg-opacity-10 text-primary">Available Points: {{
                        user.points|default:"0" }}</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light small text-muted text-uppercase">
                                <tr>
                                    <th class="ps-4 py-3">Reward</th>
                                    <th class="py-3">Cost</th>
                                    <th class="py-3 text-end pe-4">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reward in rewards %}
                                <tr>
                                    <td class="ps-4">
                                        <div class="d-flex align-items-center">
                                            <div
                                                class="bg-{{ reward.color }} bg-opacity-10 p-2 rounded me-3 text-{{ reward.color }}">
                                                <i data-lucide="{{ reward.icon }}" class="w-5 h-5"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark">{{ reward.title }}</div>
                                                <div class="small text-muted">{{ reward.description }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark border">{{ reward.points }} pts</span>
                                    </td>
                                    <td class="text-end pe-4">
                                        {% if user.points >= reward.points %}
                                        <button class="btn btn-sm btn-primary rounded-pill px-3">Claim</button>
                                        {% else %}
                                        <button class="btn btn-sm btn-light text-muted rounded-pill px-3"
                                            disabled>Locked</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-light text-center py-3">
                    <small class="text-muted">Earn more points by reporting valid grievances and participating in
                        community discussions.</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}